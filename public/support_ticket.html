<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>H·ªó tr·ª£ kh√°ch h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>G√≥i Internet - MyService</title>
    <link rel="stylesheet" href="/src/css/style.css" />
    <link rel="stylesheet" href="/src/css/service.css" />
    <script src="../src/js/layout.js" defer></script>
    <script src="../src/js/packages.js" defer></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }

        .form-section {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="header"></div>
    <div class="container my-5">
        <h2 class="text-center text-primary mb-4">üì© G·ª≠i y√™u c·∫ßu h·ªó tr·ª£</h2>

        <!-- Form h·ªó tr·ª£ -->
        <div class="form-section mb-5">
            <form id="support-form">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="fullname" class="form-label">H·ªç v√† t√™n*</label>
                        <input type="text" class="form-control" id="fullname" required>
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i*</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email*</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="col-md-6">
                        <label for="topic" class="form-label">Ch·ªß ƒë·ªÅ h·ªó tr·ª£*</label>
                        <select class="form-select" id="topic" required>
                            <option value="">-- Ch·ªçn ch·ªß ƒë·ªÅ --</option>
                            <option value="order">H·ªó tr·ª£ v·ªÅ ƒë∆°n h√†ng</option>
                            <option value="package">H·ªó tr·ª£ v·ªÅ g√≥i ƒëang d√πng</option>
                            <option value="other">Kh√°c</option>
                        </select>
                    </div>

                    <!-- Tr∆∞·ªùng nh·∫≠p ID li√™n quan -->
                    <div class="col-12 hidden" id="related-id-group">
                        <label for="related-id" class="form-label" id="related-id-label">ID li√™n quan</label>
                        <input type="text" class="form-control" id="related-id" placeholder="Nh·∫≠p ID ƒë∆°n h√†ng ho·∫∑c g√≥i">
                    </div>

                    <div class="col-12">
                        <label for="description" class="form-label">M√¥ t·∫£ y√™u c·∫ßu h·ªó tr·ª£*</label>
                        <textarea class="form-control" id="description" rows="5" required></textarea>
                    </div>

                    <div class="col-12 d-flex justify-content-end gap-3 mt-3">
                        <button type="reset" class="btn btn-outline-secondary">L√†m m·ªõi</button>
                        <button type="submit" class="btn btn-primary">G·ª≠i y√™u c·∫ßu</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Danh s√°ch y√™u c·∫ßu h·ªó tr·ª£ -->
        <!-- Danh s√°ch y√™u c·∫ßu h·ªó tr·ª£ -->
        <div class="bg-white p-4 rounded shadow-sm">
            <h4 class="mb-3 text-secondary">üìã Danh s√°ch y√™u c·∫ßu ƒë√£ g·ª≠i</h4>
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Ch·ªß ƒë·ªÅ</th>
                        <th>ID ƒë∆°n h√†ng</th>
                        <th>ID g√≥i</th>
                        <th>Nh√¢n vi√™n x·ª≠ l√Ω</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>M√¥ t·∫£</th>
                        <th>Gi·∫£i ph√°p</th>
                        <th>T·∫°o l√∫c</th>
                        <th>Ho√†n t·∫•t l√∫c</th>
                    </tr>
                </thead>
                <tbody id="ticket-list">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </tbody>
            </table>
        </div>



        <div id="footer"></div>

        <script src="/src/js/login_popup.js" defer></script>
        <script src="/src/js/login.js" defer></script>
        <!-- <script src="/src/js/info.js" defer></script> -->
        <!-- SCRIPT -->
        <script>
            // X·ª≠ l√Ω khi ch·ªçn lo·∫°i ch·ªß ƒë·ªÅ
            document.getElementById("topic").addEventListener("change", () => {
                const topic = document.getElementById("topic").value;
                const group = document.getElementById("related-id-group");
                const label = document.getElementById("related-id-label");

                if (topic === "order") {
                    label.textContent = "ID ƒë∆°n h√†ng*";
                    group.classList.remove("hidden");
                    document.getElementById("related-id").required = true;
                } else if (topic === "package") {
                    label.textContent = "ID g√≥i ƒëang d√πng*";
                    group.classList.remove("hidden");
                    document.getElementById("related-id").required = true;
                } else {
                    group.classList.add("hidden");
                    document.getElementById("related-id").required = false;
                    document.getElementById("related-id").value = "";
                }
            });

            // ƒê·ªï d·ªØ li·ªáu ng∆∞·ªùi d√πng t·ª´ localStorage v√†o form
            document.addEventListener("DOMContentLoaded", function () {
                const fullName = localStorage.getItem("fullName") || "";
                const phone = localStorage.getItem("phone") || "";
                const email = localStorage.getItem("email") || "";

                document.getElementById("fullname").value = fullName;
                document.getElementById("phone").value = phone;
                document.getElementById("email").value = email;
            });

            // G·ª≠i y√™u c·∫ßu h·ªó tr·ª£
            document.getElementById("support-form").addEventListener("submit", async function (e) {
                e.preventDefault();

                const name = document.getElementById("fullname").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const email = document.getElementById("email").value.trim();
                const topic = document.getElementById("topic").value;
                const relatedID = document.getElementById("related-id").value.trim();
                const desc = document.getElementById("description").value.trim();

                const token = localStorage.getItem("token");
                if (!token) {
                    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i y√™u c·∫ßu h·ªó tr·ª£.");
                    return;
                }

                let subject = "";
                let order_id = null;
                let subscription_id = null;

                if (topic === "order") {
                    subject = "H·ªó tr·ª£ v·ªÅ ƒë∆°n h√†ng";
                    order_id = relatedID || null;
                } else if (topic === "package") {
                    subject = "H·ªó tr·ª£ v·ªÅ g√≥i ƒëang d√πng";
                    subscription_id = relatedID || null;
                } else {
                    subject = "H·ªó tr·ª£ kh√°c";
                }

                try {
                    const response = await fetch("http://127.0.0.1:7777/create_support_ticket", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({
                            subject: subject,
                            description: desc,
                            order_id: order_id,
                            subscription_id: subscription_id
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.msg || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
                    }

                    alert("‚úÖ " + data.msg);
                    this.reset();
                    document.getElementById("related-id-group").classList.add("hidden");

                    // G·ª£i √Ω: g·ªçi l·∫°i h√†m loadSupportTickets() n·∫øu mu·ªën t·ª± ƒë·ªông reload b·∫£ng sau khi th√™m
                    // loadSupportTickets();

                } catch (error) {
                    console.error("L·ªói:", error);
                    alert("‚ùå Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu: " + error.message);
                }
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                console.log("üì¶ DOM ƒë√£ load, b·∫Øt ƒë·∫ßu g·ªçi API...");
                loadSupportTickets();
            });

            async function loadSupportTickets() {
                const customerID = localStorage.getItem("userID");
                console.log("üßæ CustomerID t·ª´ localStorage:", customerID);  // ‚úÖ In ra console

                const fullName = localStorage.getItem("fullName") || "";
                const phone = localStorage.getItem("phone") || "";

                if (!customerID) {
                    alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID kh√°ch h√†ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    return;
                }

                try {
                    const res = await fetch(`http://127.0.0.1:7777/support_ticket/${customerID}`);
                    const tickets = await res.json();

                    const list = document.getElementById("ticket-list");
                    list.innerHTML = "";

                    if (!Array.isArray(tickets) || tickets.length === 0) {
                        const row = document.createElement("tr");
                        row.innerHTML = `<td colspan="11" class="text-center text-muted">Kh√¥ng c√≥ y√™u c·∫ßu h·ªó tr·ª£ n√†o.</td>`;
                        list.appendChild(row);
                        return;
                    }

                    tickets.forEach((ticket, index) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${fullName}<br><small>${phone}</small></td>
                    <td>${ticket.Subject}</td>
                    <td>${ticket.OrderID || "-"}</td>
                    <td>${ticket.SubscriptionID || "-"}</td>
                    <td>${ticket.EmployeeID || "-"}</td>
                    <td>${formatStatus(ticket.Status)}</td>
                    <td>${ticket.Description}</td>
                    <td>${ticket.Resolution || "-"}</td>
                    <td>${ticket.CreatedAt || "-"}</td>
                    <td>${ticket.ResolvedAt || "-"}</td>
                `;
                        list.appendChild(row);
                    });

                } catch (err) {
                    console.error("‚ùå L·ªói khi t·∫£i danh s√°ch:", err);
                    alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch y√™u c·∫ßu h·ªó tr·ª£.");
                }
            }

            function formatStatus(status) {
                switch (status) {
                    case "open": return "üü° M·ªõi t·∫°o";
                    case "in_progress": return "üü† ƒêang x·ª≠ l√Ω";
                    case "resolved": return "üü¢ ƒê√£ x·ª≠ l√Ω";
                    case "closed": return "‚ö™ ƒê√£ ƒë√≥ng";
                    default: return status || "-";
                }
            }
        </script>





</body>

</html>